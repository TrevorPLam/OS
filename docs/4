# Decision Log (ADR-lite)

This file records major architecture and product decisions that affect invariants, data models, and implementation boundaries.

Purpose:
- Make it explicit what is decided vs still open
- Prevent re-litigating decisions in code review
- Give reviewers a clear map of constraints and tradeoffs

Rules:
1. Every decision must link to the spec sections it affects.
2. Every “Accepted” decision must be reflected in SYSTEM_SPEC.md (or explicitly marked “Deferred” with a target).
3. If a decision is open, it belongs in OPEN_QUESTIONS.md (with options + consequences).
4. Deprecated decisions stay here with a clear replacement link.

Decision status values:
- Proposed
- Accepted
- Deprecated

Template (copy/paste for new entries):

## ADR-XXXX: <Title>
Status: Proposed | Accepted | Deprecated  
Date: YYYY-MM-DD  
Owners: <names/roles>  
Related: <links to specs / PRs>

Context  
- What problem are we solving?
- What constraints matter (audit, multi-tenancy, integrations, etc.)?

Decision  
- The decision in one sentence.
- What is in scope vs out of scope.

Consequences  
Positive:
- ...
Negative / tradeoffs:
- ...
Risks:
- ...

Alternatives considered  
- Option A: why rejected
- Option B: why rejected

Spec impact  
- SYSTEM_SPEC.md: <sections>
- DOMAIN_MODEL.md: <sections>
- Other docs: <sections>

---

## Decisions

## ADR-0001: Tenancy model is schema-per-tenant
Status: Accepted  
Date: 2025-12-28  
Owners: Platform  
Related: ARCHITECTURE_OVERVIEW.md; SYSTEM_SPEC.md (Tenancy); DB_SCHEMA_AND_MIGRATIONS.md

Context  
- Regulated, audit-sensitive workflows require strong tenant isolation.
- We want predictable data boundaries and reduced blast radius.

Decision  
- Each firm (tenant) is isolated using a dedicated database schema.
- Shared/global tables (if any) are explicitly separated and minimized.

Consequences  
Positive:
- Strong isolation, simpler compliance posture, clearer operational boundaries.
- Easier to reason about tenant-scoped migrations and audits.
Negative / tradeoffs:
- More complex provisioning, migrations, and operational tooling.
- Cross-tenant analytics require explicit aggregation patterns.

Alternatives considered  
- Row-level tenancy in shared schema: rejected due to higher accidental exposure risk and more complex permission/query enforcement.
- Separate database per tenant: rejected for operational overhead at SMB scale (may be reconsidered for large tenants later).

Spec impact  
- SYSTEM_SPEC.md: Tenancy + isolation invariants  
- DB_SCHEMA_AND_MIGRATIONS.md: provisioning + migration runner  
- OBSERVABILITY_AND_SRE.md: per-tenant monitoring strategy

---

## ADR-0002: Canonical core object graph
Status: Accepted  
Date: 2025-12-28  
Owners: Platform + Product  
Related: ARCHITECTURE_OVERVIEW.md; SYSTEM_SPEC.md; DOMAIN_MODEL.md

Context  
- CRM, intake, delivery, documents, and billing often drift into disconnected “modules.”
- A stable object graph enables consistent permissions, auditability, and linking.

Decision  
- The canonical core object graph is:
  - Account / Contact / Engagement / EngagementLine / WorkItem
- Cross-domain artifacts (documents, conversations, appointments, invoices) attach through explicit associations to this graph.

Consequences  
Positive:
- Consistent linking, permission evaluation, and audit references.
- Reduces “orphan” artifacts and shadow workflows.
Negative / tradeoffs:
- Requires discipline to prevent ad-hoc “shortcut” entities that bypass the graph.

Alternatives considered  
- Separate module-specific primary objects: rejected due to broken cross-module workflows and duplicated identity.

Spec impact  
- SYSTEM_SPEC.md: domain boundaries and invariants  
- DOMAIN_MODEL.md: entity definitions and relationships  
- PERMISSIONS_MODEL.md: evaluation anchors

---

## ADR-0003: Intake, pricing, and engagements fold into CRM (not separate modules)
Status: Accepted  
Date: 2025-12-28  
Owners: Product + Platform  
Related: SYSTEM_SPEC.md; DOMAIN_MODEL.md; PRICING_ENGINE_SPEC.md

Context  
- Professional services workflows require a coherent lifecycle from lead → scoped work → delivery.
- Separating intake/pricing into standalone modules creates handoff errors and duplicated identity.

Decision  
- Intake, qualification, and pricing are CRM-adjacent flows operating on the same Account/Contact and producing Engagement drafts and QuoteVersions.
- Engagement activation is the explicit transition that “starts delivery.”

Consequences  
Positive:
- Fewer handoff seams; clearer lifecycle.
- Pricing snapshots (QuoteVersion) attach to Engagement/EngagementLine cleanly.
Negative / tradeoffs:
- CRM becomes more “systems-of-record” than a simple sales tracker.

Alternatives considered  
- Separate intake/quoting app: rejected due to duplication and brittle syncing.

Spec impact  
- SYSTEM_SPEC.md: lifecycle invariants and transitions  
- PRICING_ENGINE_SPEC.md: quote snapshotting rules  
- DOMAIN_MODEL.md: Engagement/Quote/Activation states

---

## ADR-0004: Pricing rules are versioned JSON with trace output
Status: Proposed  
Date: 2025-12-28  
Owners: Platform  
Related: PRICING_ENGINE_SPEC.md; SYSTEM_SPEC.md

Context  
- Pricing must be explainable, auditable, and snapshot-able at the time of agreement.
- Non-coders must be able to evolve pricing without redeploying core systems (within guardrails).

Decision  
- Pricing rules are defined as a versioned JSON schema.
- Evaluator produces (a) outputs and (b) a detailed trace.
- Accepted quotes create immutable QuoteVersions.

Consequences  
Positive:
- Auditable, reproducible pricing results.
- Enables rule snapshotting and comparisons across time.
Negative / tradeoffs:
- Requires strong schema validation and tooling to prevent rule drift.
- Debugging requires trace UX and stable evaluation context.

Alternatives considered  
- Code-based pricing logic only: rejected due to limited agility and harder audit reproducibility.
- Spreadsheet-first pricing: rejected as a primary engine due to brittle versioning and weak audit semantics (can exist as an authoring surface only).

Spec impact  
- PRICING_ENGINE_SPEC.md: schema + evaluation context + trace  
- DOMAIN_MODEL.md: Quote/QuoteVersion  
- API_CONTRACTS.md: pricing endpoints + trace retrieval

---

## ADR-0005: Dual workflow model naming and semantics
Status: Proposed  
Date: 2025-12-28  
Owners: Product + Platform  
Related: DELIVERY_TEMPLATES_SPEC.md; ORCHESTRATION_ENGINE_SPEC.md; SYSTEM_SPEC.md

Context  
- The platform needs both:
  1) human-facing delivery plans (templates into WorkItems), and
  2) machine-enforced orchestration (steps, retries, DLQ).
- Conflating these creates confusion and hard-to-debug “automation magic.”

Decision  
- Delivery Templates define the WorkItem plan (DAG of deliverables/tasks).
- Orchestration defines execution control (step workflows, retries, compensation).
- Naming must reflect the distinction, and cross-links must be explicit.

Consequences  
Positive:
- Clear separation of intent (delivery plan) vs mechanism (execution engine).
Negative / tradeoffs:
- More concepts to teach; requires good docs and UI labeling.

Alternatives considered  
- Single “workflow engine” for everything: rejected due to poor clarity and higher blast radius for changes.

Spec impact  
- DELIVERY_TEMPLATES_SPEC.md and ORCHESTRATION_ENGINE_SPEC.md  
- SYSTEM_SPEC.md: boundaries and invariants

---

## ADR-0006: Identity decoupling model (staff vs portal contacts)
Status: Proposed  
Date: 2025-12-28  
Owners: Platform  
Related: PERMISSIONS_MODEL.md; SYSTEM_SPEC.md; CLIENT_PORTAL_INFORMATION_ARCHITECTURE.md

Context  
- Professional-services organizations need strict separation between internal users and external client contacts.
- Portal contacts may belong to multiple Accounts and must have scoped access.

Decision  
- Staff identity is internal RBAC.
- Portal identity is contact-scoped with explicit Account associations and permission scopes.
- “Account switcher” is supported when a portal identity is linked to multiple Accounts.

Consequences  
Positive:
- Least-privilege defaults and clearer external access control.
Negative / tradeoffs:
- More complex permission evaluation and UI gating.

Alternatives considered  
- Treat portal users as standard users with limited roles: rejected due to weaker separation and higher risk of accidental privilege escalation.

Spec impact  
- PERMISSIONS_MODEL.md: portal scopes and evaluation rules  
- DOMAIN_MODEL.md: Contact ↔ portal identity mapping  
- SECURITY_MODEL.md: threat model for portal access

---

## ADR-0007: Recurrence generation uses dedupe constraints + idempotent workers
Status: Proposed  
Date: 2025-12-28  
Owners: Platform  
Related: RECURRENCE_ENGINE_SPEC.md; WORKERS_AND_QUEUES.md

Context  
- Recurring work (monthly close, quarterly filings, etc.) is a core professional-services pattern.
- DST/timezone behavior and retries commonly cause duplicate work creation.

Decision  
- Introduce a RecurrenceGeneration table with strict uniqueness constraints for (template, period, anchor, tenant).
- Workers must be idempotent and use advisory locks / SKIP LOCKED patterns where appropriate.
- Pause/resume/cancel semantics must not duplicate already-instantiated work.

Consequences  
Positive:
- Prevents duplicates under retries and concurrent workers.
- Enables traceability for “why did this get generated?”
Negative / tradeoffs:
- Requires careful period definition rules and explicit timezone policy.

Alternatives considered  
- Generate “on read” only: rejected due to unpredictability and poor auditability.
- Cron-style triggers without dedupe: rejected due to duplicate risk.

Spec impact  
- RECURRENCE_ENGINE_SPEC.md: period rules + dedupe + algorithm  
- WORKERS_AND_QUEUES.md: job concurrency and locking

---

## ADR-0008: Document versioning + locking semantics
Status: Proposed  
Date: 2025-12-28  
Owners: Platform  
Related: DOCUMENTS_AND_STORAGE_SPEC.md; PERMISSIONS_MODEL.md

Context  
- Audit-sensitive workflows require defensible document history.
- Teams need guardrails against silent overwrites and uncontrolled sharing.

Decision  
- Documents are versioned, and selected document types support explicit locking.
- Access is through signed URLs with policy enforcement.
- Document access must be logged (who/when/what).

Consequences  
Positive:
- Clear provenance and defensibility of artifacts.
Negative / tradeoffs:
- More complexity in upload/edit flows and conflict resolution UX.

Alternatives considered  
- Simple file storage with last-write-wins: rejected due to audit and collaboration risks.

Spec impact  
- DOCUMENTS_AND_STORAGE_SPEC.md: versioning, locking, signed URL policies, logging  
- PERMISSIONS_MODEL.md: document permission evaluation

---

## ADR-0009: Billing is ledger-first (invoices, payments, retainers as entries)
Status: Proposed  
Date: 2025-12-28  
Owners: Platform + Finance domain  
Related: BILLING_LEDGER_SPEC.md; SYSTEM_SPEC.md

Context  
- Billing must be explainable and auditable.
- Retainers and allocations create edge cases that “invoice-only” models mishandle.

Decision  
- Model all billing movements as ledger entries (invoice, payment, retainer credits, allocations).
- Reports (AR, retainer balance, earned revenue) derive from entries.
- Idempotency requirements apply to posting operations.

Consequences  
Positive:
- Strong auditability; clear reconciliation.
Negative / tradeoffs:
- Requires careful allocation constraints and reporting correctness.

Alternatives considered  
- Invoice-only model with computed balances: rejected due to audit weakness and retainer complexity.

Spec impact  
- BILLING_LEDGER_SPEC.md: entry types, allocations, constraints, reports  
- EDGE_CASES_CATALOG.md: idempotency and allocation edge cases

---

## ADR-0010: Communications include native chat plus email ingestion
Status: Proposed  
Date: 2025-12-28  
Owners: Product + Platform  
Related: EMAIL_INGESTION_SPEC.md; (future) COMMUNICATIONS_SPEC.md; DOCUMENTS_AND_STORAGE_SPEC.md

Context  
- Firms need communication in context with work, and clients expect portal messaging.
- Email remains a reality; attachments must become governed artifacts.

Decision  
- Provide native conversation threads (staff↔staff, staff↔client) plus email ingestion that stores emails/attachments as artifacts with mapping suggestions and audit.
- Email ingestion does not become the authoritative “conversation model”; it is an ingestion source feeding governed artifacts.

Consequences  
Positive:
- Reduces shadow communication and scattered attachments.
Negative / tradeoffs:
- Requires strong threading/staleness heuristics and correction workflows.

Alternatives considered  
- “Email only” communications: rejected due to poor in-context collaboration and portal UX.
- “Chat only” with no email integration: rejected as unrealistic for firm operations.

Spec impact  
- EMAIL_INGESTION_SPEC.md: mapping, staleness, correction and audit  
- DOCUMENTS_AND_STORAGE_SPEC.md: attachment artifact handling  
- COMMUNICATIONS_SPEC.md: thread model and permissions (to be created)

---

