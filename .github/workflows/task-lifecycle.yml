name: Task Lifecycle Automation

# Automatically archive completed tasks and promote next tasks from the backlog
# Runs when a PR is merged to main branch

on:
  pull_request:
    types: [closed]
    branches:
      - main
  workflow_dispatch:  # Allow manual triggering

permissions:
  contents: write
  pull-requests: write

jobs:
  task-lifecycle:
    name: Archive and Promote Tasks
    runs-on: ubuntu-latest
    # Only run if PR was merged (not just closed)
    if: github.event.pull_request.merged == true || github.event_name == 'workflow_dispatch'
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Fetch all history for proper git operations
          token: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'
      
      - name: Check if task completion is indicated in PR
        id: check_task
        run: |
          # Check if PR title or body mentions task completion
          PR_TITLE="${{ github.event.pull_request.title }}"
          PR_BODY="${{ github.event.pull_request.body }}"
          
          # Check for task completion indicators
          if echo "$PR_TITLE $PR_BODY" | grep -qiE '(complete|completes|completed|finish|finished|resolve|resolves|resolved) *TASK-[0-9]+'; then
            echo "task_complete=true" >> $GITHUB_OUTPUT
            echo "Task completion detected in PR #${{ github.event.pull_request.number }}"
          elif grep -q "^\- \[x\]" .repo/tasks/TODO.md && ! grep -q "^\- \[ \]" .repo/tasks/TODO.md; then
            # All acceptance criteria are checked
            echo "task_complete=true" >> $GITHUB_OUTPUT
            echo "All acceptance criteria are complete in TODO.md"
          else
            echo "task_complete=false" >> $GITHUB_OUTPUT
            echo "Task completion not detected"
          fi
      
      - name: Archive completed task
        if: steps.check_task.outputs.task_complete == 'true'
        run: |
          echo "Archiving completed task..."
          python scripts/archive-task.py --force || {
            echo "::warning::Failed to archive task automatically. Manual intervention may be required."
            exit 0  # Don't fail the workflow, just warn
          }
      
      - name: Promote next task from backlog
        if: steps.check_task.outputs.task_complete == 'true'
        run: |
          echo "Promoting next task from backlog..."
          bash scripts/promote-task.sh || {
            echo "::warning::Failed to promote next task. Backlog may be empty or TODO.md may need manual cleanup."
            exit 0  # Don't fail the workflow, just warn
          }
      
      - name: Configure Git
        if: steps.check_task.outputs.task_complete == 'true'
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
      
      - name: Commit and push task lifecycle changes
        if: steps.check_task.outputs.task_complete == 'true'
        run: |
          # Check if there are changes to commit
          if git diff --quiet && git diff --staged --quiet; then
            echo "No task lifecycle changes to commit"
            exit 0
          fi
          
          # Add task management files
          git add .repo/tasks/TODO.md .repo/tasks/BACKLOG.md .repo/tasks/ARCHIVE.md || true
          
          # Commit if there are staged changes
          if ! git diff --staged --quiet; then
            git commit -m "chore: Automated task lifecycle - archive and promote tasks [skip ci]" \
              -m "Triggered by PR #${{ github.event.pull_request.number }}" \
              -m "Auto-archived completed task and promoted next task from backlog"
            
            # Push changes back to main
            git push origin main || {
              echo "::error::Failed to push task lifecycle changes. Manual intervention required."
              exit 1
            }
            
            echo "✅ Task lifecycle changes committed and pushed"
          else
            echo "No changes to commit after staging"
          fi
      
      - name: Post workflow summary
        if: always()
        run: |
          echo "## Task Lifecycle Automation Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **PR**: #${{ github.event.pull_request.number }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Task Complete**: ${{ steps.check_task.outputs.task_complete }}" >> $GITHUB_STEP_SUMMARY
          
          if [[ "${{ steps.check_task.outputs.task_complete }}" == "true" ]]; then
            echo "- **Action**: Archived completed task and promoted next task" >> $GITHUB_STEP_SUMMARY
          else
            echo "- **Action**: No task lifecycle changes needed" >> $GITHUB_STEP_SUMMARY
          fi
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Current TODO.md status:" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          head -30 .repo/tasks/TODO.md >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
      
      - name: Notify on failure
        if: failure()
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: '⚠️ **Task Lifecycle Automation Failed**\n\nThe automated task archiving and promotion encountered an error. Please check the [workflow run](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}) for details.\n\nManual intervention may be required to update `.repo/tasks/` files.'
            })
