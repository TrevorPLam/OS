{
  "$schema": "https://json-schema.org/draft/2020-12/schema",
  "$id": "spec/billing/INVOICE_LINE.schema.json",
  "title": "InvoiceLine",
  "type": "object",
  "description": "Invoice line items are append-only billing facts. Updates must be represented via adjustments, not mutation.",
  "additionalProperties": false,
  "required": [
    "invoice_id",
    "invoice_line_id",
    "client_id",
    "pricing_basis",
    "trigger_type",
    "trigger_ref",
    "quantity",
    "unit",
    "rate",
    "amount",
    "currency",
    "created_at",
    "created_by"
  ],
  "properties": {
    "invoice_id": {
      "type": "string",
      "description": "Immutable identifier for the invoice."
    },
    "invoice_line_id": {
      "type": "string",
      "description": "Immutable identifier for the invoice line."
    },
    "client_id": {
      "type": "string",
      "description": "Client identifier associated with the invoice line."
    },
    "engagement_id": {
      "type": ["string", "null"],
      "description": "Engagement identifier when applicable."
    },
    "pricing_basis": {
      "type": "string",
      "enum": ["time", "milestone", "usage"],
      "description": "Pricing basis aligned to BillableEvent type."
    },
    "trigger_type": {
      "type": "string",
      "enum": ["billable_event", "internal_approval"],
      "description": "Source of the trigger that generated this line."
    },
    "trigger_ref": {
      "type": "string",
      "description": "Reference to BillableEvent ID or internal approval record."
    },
    "quantity": {
      "type": "number",
      "minimum": 0,
      "description": "Quantity of units billed."
    },
    "unit": {
      "type": "string",
      "description": "Unit of measure (e.g., hours, units, milestones)."
    },
    "rate": {
      "type": "number",
      "minimum": 0,
      "description": "Rate per unit in the invoice currency."
    },
    "amount": {
      "type": "number",
      "minimum": 0,
      "description": "Total line amount (quantity * rate) in invoice currency."
    },
    "currency": {
      "type": "string",
      "description": "ISO currency code for the line."
    },
    "created_at": {
      "type": "string",
      "format": "date-time",
      "description": "Creation timestamp."
    },
    "created_by": {
      "type": "string",
      "description": "Actor identifier who created the line."
    },
    "status": {
      "type": "string",
      "enum": ["draft", "final"],
      "description": "Lifecycle state without overwriting historical lines."
    }
  }
}
